# Prometheus Alert Rules
# These rules are automatically loaded by Prometheus Operator

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kubernetes-alerts
  namespace: observability
  labels:
    app: prometheus
    release: prometheus
spec:
  groups:
    - name: kubernetes.rules
      interval: 30s
      rules:
        # Node Alerts
        - alert: NodeHighCPUUsage
          expr: 100 - (avg(irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High CPU usage on node {{ $labels.instance }}"
            description: "CPU usage is above 80% for 5 minutes"

        - alert: NodeHighMemoryUsage
          expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.9
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High memory usage on node {{ $labels.instance }}"
            description: "Memory usage is above 90% for 5 minutes"

        - alert: NodeDiskSpaceRunningOut
          expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) < 0.1
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Disk space running out on node {{ $labels.instance }}"
            description: "Disk space is below 10%"

        # Pod Alerts
        - alert: PodHighCPUUsage
          expr: rate(container_cpu_usage_seconds_total[5m]) > 0.8
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High CPU usage in pod {{ $labels.pod }}"
            description: "CPU usage is above 80% for 5 minutes"

        - alert: PodHighMemoryUsage
          expr: (container_memory_usage_bytes / container_spec_memory_limit_bytes) > 0.9
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High memory usage in pod {{ $labels.pod }}"
            description: "Memory usage is above 90% for 5 minutes"

        - alert: PodCrashLooping
          expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Pod {{ $labels.pod }} is crash looping"
            description: "Pod has restarted multiple times in the last 15 minutes"

        # Deployment Alerts
        - alert: DeploymentReplicasMismatch
          expr: kube_deployment_spec_replicas != kube_deployment_status_replicas_available
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Deployment {{ $labels.deployment }} replicas mismatch"
            description: "Expected {{ $value }} replicas but only {{ $labels.available }} are available"

        # Service Alerts
        - alert: ServiceDown
          expr: up{job="kubernetes-services"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Service {{ $labels.service }} is down"
            description: "Service has been down for 5 minutes"

